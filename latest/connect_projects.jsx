// connect_projects.jsx// this is an adition to the allIncomProjects.jsx// it connects the projects with the text// maybee i will move it to the other script - // but a break within the scripts is also good// gives some room for tiny manual tweaks// Copyright (C) 2012 Fabian "fabiantheblind" Morón Zirfas// http://www.the-moron.net// http://fabiantheblind.info/// info [at] the - moron . net// This program is free software: you can redistribute it and/or modify// it under the terms of the GNU General Public License as published by// the Free Software Foundation, either version 3 of the License, or// any later version.// This program is distributed in the hope that it will be useful,// but WITHOUT ANY WARRANTY; without even the implied warranty of// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the// GNU General Public License for more details.// You should have received a copy of the GNU General Public License// along with this program.  If not, see http://www.gnu.org/licenses/#include db.jsonvar meta = new Object();	meta.db = data;// this comes from the included db.json	meta.highlite = [	{"id":1173,"name":"1173","col":[153,51,255]},	{"id":1362,"name":"1362","col":[102,153,255]},	{"id":1754,"name":"1754","col":[51,204,204]}	];    meta.coordInText = null;    meta.highliteOnly = false;    meta.DEBUG = false;    db_sort_by_starttime();    db_remove_firstelement();// removes old junk    meta.pw =null;    meta.ph = null;    meta.x1coords = new Array();//~         meta.x1coords.push(0);    main();function main(){var d = app.activeDocument;doc_modify(d);var p = d.pages.item(0);//~ alert(p.groups.length);meta.coordInText = text_find_ids(d);var bnds = util_get_masterframeBounds(p);//~ var target = p.ovals.add({geometricBounds:[0,0,10,10]}); for(var  i = p.groups.length -1; i >=0 ;i--){    var grp = p.groups.item(i);    var id =  grp.label;    var list = null;if(meta.highliteOnly ){        list = meta.highlite;        }else{        list = meta.db.projects;        }        var offset = 5;    for(var j = list.length - 1; j >= 0;j--){                          if(id.match("projid "+ list[j].id) ){                     var coords = util_get_coordByID(list[j].id);                var w = grp.geometricBounds[3] - grp.geometricBounds[1];                var h = grp.geometricBounds[2] - grp.geometricBounds[0];                var x1 = grp.geometricBounds[1] + (w/2);                var y1 = grp.geometricBounds[0] + (h/2);                var x2 = coords[0] - 5;                var y2 = coords[1] - 2;                var yc_down = bnds[0]  - (offset);                var yc_up = bnds[0] - offset*7;                var gl = draw_line (p, x1, y1, x2, y2,yc_up,yc_down,w);                gl.strokeColor = d.swatches.item(list[j].id+"");                gl.strokeWeight = 1;                gl.itemLayer = "lines";                shift_lines_x_p2_p3(p,gl);                shift_lines_y_p3_p4(p,gl);                shift_lines_x_p4_p5(p,gl);                }        }        }//~ for (var i = p.groups.length -1; i >=0;i--){//~             var grp = p.groups.item(i );//~            var preItem = p.groups.item(i + 1);//~        if(preItem != null){//~            //~           if(grp.label.match(preItem.label) && i != p.groups.length -1){//~             if((preItem.geometricBounds[1] - grp.geometricBounds[1]) > 20){//~                 var obj = {//~                     "geometricBounds":[//~                     preItem.geometricBounds[0] + 100,//~                     preItem.geometricBounds[1] + 100,//~                     preItem.geometricBounds[2] + 100,//~                     preItem.geometricBounds[3] + 100//~                     ]};//~          draw_line_withBounds (grp, preItem);//~          }else{//~              //~          draw_line_withBounds (grp, preItem);//~              //~              }//~                 }  //~            }//~     //~     }return 0;}// this draws the lines with 4 pathpointsfunction draw_line(p,x1,y1,x2,y2,y3,y4,w){   	var gl = p.graphicLines.add();         var p1 = gl.paths[0].pathPoints[0];    var p2 = gl.paths[0].pathPoints[1];        var p3 = gl.paths[0].pathPoints.add();    var p4 = gl.paths[0].pathPoints.add();    var p5 = gl.paths[0].pathPoints.add();        p1.anchor  = [x1,y1]; //~     p1.rightDirection = [x1,y1 + 100];//~     p1.rightDirection = [x1,y1+200];    var x1Off = x1 - (w /2) ;    p2.anchor = [x1Off,y1];    var anchrOff = 5;//~     $.writeln(anchrOff  );    p2.rightDirection = [x1Off-anchrOff,y1+anchrOff];//~ p2.leftDirection = [x1Off+10,y1+10];        p3.anchor = [x1Off,y3];//~     p3.rightDirection = [x1Off+anchrOff,y3+anchrOff];        p4.anchor = [x2,y3];//~     p4.rightDirection = [x2+anchrOff,y3+anchrOff];    p5.anchor = [x2,y2];    p5.leftDirection = [x2-anchrOff,y2-anchrOff];     var p6 = gl.paths[0].pathPoints.add();    p6.anchor = [x2 + 3,y2];//~     p3.leftDirection = [x2,yc - 10];//~     p2.rightDirection = [x2,y2 - 100];        //~ 	gl.paths[0].pathPoints[0].anchor  = [x1,y1]; //~ 	gl.paths[0].pathPoints[1].anchor = [x2,y2];         return gl;    }function shift_lines_x_p2_p3(p,gl1){    var count = 0;            for(var j = p.graphicLines.length-1; j >=0 ;j--){                var gl2 = p.graphicLines.item(j);                                 if((gl1.paths[0].pathPoints[1].anchor[0] == gl2.paths[0].pathPoints[1].anchor[0]) &&(j != gl1.index)){                   var x1 = gl1.paths[0].pathPoints[1].anchor[0] + 1;                   var y1 = gl1.paths[0].pathPoints[1].anchor[1];                                      var x2 = gl1.paths[0].pathPoints[2].anchor[0] + 1;                   var y2 = gl1.paths[0].pathPoints[2].anchor[1];                                        gl1.paths[0].pathPoints[1].anchor = [x1,y1];                    gl1.paths[0].pathPoints[2].anchor = [x2,y2];                    j = 0;                    }            }            }function shift_lines_y_p3_p4(p,gl1){    var count = 0;            for(var j = 0; j < p.graphicLines.length;j++){                var gl2 = p.graphicLines.item(j);                                 if((gl1.paths[0].pathPoints[2].anchor[1] == gl2.paths[0].pathPoints[2].anchor[1]) &&(j != gl1.index)){                   var x1 = gl1.paths[0].pathPoints[2].anchor[0] ;                   var y1 = gl1.paths[0].pathPoints[2].anchor[1] + 1;                                      var x2 = gl1.paths[0].pathPoints[3].anchor[0] ;                   var y2 = gl1.paths[0].pathPoints[3].anchor[1] +1;                                        gl1.paths[0].pathPoints[2].anchor = [x1,y1];                    gl1.paths[0].pathPoints[3].anchor = [x2,y2];                    j = 0;                    }            }            }function shift_lines_x_p4_p5(p,gl1){    var count = 0;            for(var j = p.graphicLines.length-1; j >=0 ;j--){                var gl2 = p.graphicLines.item(j);                                 if((gl1.paths[0].pathPoints[3].anchor[0] == gl2.paths[0].pathPoints[3].anchor[0]) &&(j != gl1.index)){                   var x1 = gl1.paths[0].pathPoints[3].anchor[0] + 1;                   var y1 = gl1.paths[0].pathPoints[3].anchor[1];                                      var x2 = gl1.paths[0].pathPoints[4].anchor[0] + 1;                   var y2 = gl1.paths[0].pathPoints[4].anchor[1];                                        gl1.paths[0].pathPoints[3].anchor = [x1,y1];                    gl1.paths[0].pathPoints[4].anchor = [x2,y2];                    j = 0;                    }            }            }function draw_line_withBounds(c1, c2){    //~     var c1 = app.selection[0]; //~ 	var c2 = app.selection[1]; 	 	var gb = c1.geometricBounds; 	var r1 = (gb[3]-gb[1])/2; 	var x1 = gb[1]+r1; 	var y1 = gb[0]+r1; 	 	gb = c2.geometricBounds; 	var r2 = (gb[3]-gb[1])/2; 	 	var x2 = gb[1]+r2; 	var y2 = gb[0]+r2;  	var gl = c1.parent.graphicLines.add();     var p1 = gl.paths[0].pathPoints[0];    var p2 = gl.paths[0].pathPoints[1];          p1.anchor  = [x1,y1]; //~     p1.rightDirection = [x1,y1 + 100];//~     p1.rightDirection = [x1,y1 - 100];    p2.anchor = [x2,y2]; //~         p1.rightDirection = [x2,y2 + 100];//~     p1.rightDirection = [x2,y2 - 100];        }function doc_modify(doc){	try{    var l = doc.layers.add({name:"lines"});    l.move(LocationOptions.AT_END);    }catch(e){           if(meta.DEBUG) alert("layer lines already exists\n" + e);        }        meta.pw = doc.documentPreferences.pageWidth ;    meta.ph = doc.documentPreferences.pageHeight ;    }	 /**	 * this sorts by starttime	 */ function db_sort_by_starttime(){      meta.db.projects.sort(util_custom_sort);   		}   /**	* this is a fix for an old project	*/function db_remove_firstelement(){	meta.db.projects.shift();	}function util_get_masterframeBounds(page){var bounds = null;for(var i = 0; i < page.textFrames.length; i++){            if(page.textFrames[i].label.match("masterframe")){                                bounds = page.textFrames[i].geometricBounds;                }                }    return bounds;        }// this function sorts by time// found here// http://stackoverflow.com/questions/3859239/sort-json-by-datefunction util_custom_sort(a, b) {	return new Date(util_iso_to_datim(a.datetimeStart)).getTime() - 	new Date(util_iso_to_datim(b.datetimeStart)).getTime();}function util_get_coordByID(id){    for(var i = 0; i < meta.coordInText.length; i++){        if(id == meta.coordInText[i].id){        return [meta.coordInText[i].x,meta.coordInText[i].y];        }    }}// found here// http://www.topsoft.at/pstrainer/pstrainer.phpfunction util_iso_to_datim(iso) {var d=null;var len=iso.length;	if(len>=19) {		var hh = parseInt(iso.substr(11,2),10);		var mi = parseInt(iso.substr(14,2),10);		var ss = parseInt(iso.substr(17,2),10);		}else {			var hh=0;			var mi=0;			var ss=0;			}		if(len>=10) {		var yy = parseInt(iso.substr(0,4),10);		var mo = parseInt(iso.substr(5,2),10)-1;		var dd = parseInt(iso.substr(8,2),10);		d = new Date(yy,mo,dd,hh,mi,ss);		}else{			d=new Date();    }return d;}function util_checkhighlite(id){		var bool = false;	for(var i = 0; i < meta.highlite.length; i++){				if(id == meta.highlite[i].id && id != 0){			bool = true;			break			}				}	return bool;	}function text_find_ids(doc){   var fTPref  = app.findTextPreferences;    var cTPref = app.changeTextPreferences;	var result = new Array();	text_emptyFC();        var list = null;    if(meta.highliteOnly ){        list = meta.highlite;        }else{        list = meta.db.projects;        }        	// now loop thru the object to get all the greps	for(var j = 0;j < list.length;j++){        fTPref.findWhat = "i";        fTPref.appliedCharacterStyle = "id "+list[j].id;//~         cTPref.leading = 16;//~         if(util_checkhighlite (list[j].id)){        var res = doc.findText();//~         alert(res.length);//~ x: app.selection[0].horizontalOffset//~ y: app.selection[0].baseline        //~         alert( "x: " +  res[0].horizontalOffset +" y: "+ res[0].baseline);        result.push({"x":res[0].horizontalOffset,"y":res[0].baseline, "id":list[j].id});//~         alert(result.toSource());//~         }//~         alert(res);        text_emptyFC();	}	text_emptyFC();                return result;    }function text_set_FindChange_opt(){		text_emptyFC();	//Set the find options.	app.findChangeGrepOptions.includeFootnotes = true;	app.findChangeGrepOptions.includeHiddenLayers = false;	app.findChangeGrepOptions.includeLockedLayersForFind = false;	app.findChangeGrepOptions.includeLockedStoriesForFind = true;	app.findChangeGrepOptions.includeMasterPages = true;	}function text_emptyFC(){	//Clear the find/change grep preferences.	app.findGrepPreferences = NothingEnum.nothing;	app.changeGrepPreferences = NothingEnum.nothing;		//Clear the find/change text preferences.	app.findTextPreferences = NothingEnum.nothing;	app.changeTextPreferences = NothingEnum.nothing;}//~ based on this//~ found here://~ http://www.hilfdirselbst.ch/gforum/gforum.cgi?post=486547#486547//~ if (app.selection.length == 2) //~ 	main(); //~  //~ function main() { //~ 	var c1 = app.selection[0]; //~ 	var c2 = app.selection[1]; //~ 	 //~ 	var gb = c1.geometricBounds; //~ 	var r1 = (gb[3]-gb[1])/2; //~ 	var x1 = gb[1]+r1; //~ 	var y1 = gb[0]+r1; //~ 	 //~ 	gb = c2.geometricBounds; //~ 	var r2 = (gb[3]-gb[1])/2; //~ 	 //~ 	var x2 = gb[1]+r2; //~ 	var y2 = gb[0]+r2; //~  //~ 	var gl = c1.parent.graphicLines.add(); //~ 	gl.paths[0].pathPoints[0].anchor  = [x1,y1]; //~ 	gl.paths[0].pathPoints[1].anchor = [x2,y2]; //~  //~ 	var alpha = Math.atan2 (y2-y1, x2-x1); //~ 	var dx1 = Math.cos( alpha ) * r1; //~ 	var dy1 = Math.sin( alpha ) * r1; //~ 	var dx2 = Math.cos( alpha ) * r2; //~ 	var dy2 = Math.sin( alpha ) * r2; //~ 	var x11 = x1 + dx1; //~ 	var y11 = y1 + dy1; //~ 	var x21 = x2 - dx2; //~ 	var y21 = y2 - dy2; //~ 	 //~ 	var gl = c1.parent.graphicLines.add(); //~ 	gl.paths[0].pathPoints[0].anchor  = [x11,y11]; //~ 	gl.paths[0].pathPoints[1].anchor = [x21,y21]; //~ } 